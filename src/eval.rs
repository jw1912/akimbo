use std::ops::{AddAssign, SubAssign};

use crate::{init, position::Position};

pub fn eval(pos: &Position) -> i32 {
    let score = pos.pst();

    [1, -1][pos.stm()] * score.taper(pos.phase)
}

#[derive(Clone, Copy, Default)]
pub struct S(i16, i16);

impl AddAssign<S> for S {
    fn add_assign(&mut self, rhs: S) {
        self.0 += rhs.0;
        self.1 += rhs.1;
    }
}

impl SubAssign<S> for S {
    fn sub_assign(&mut self, rhs: S) {
        self.0 -= rhs.0;
        self.1 -= rhs.1;
    }
}

impl S {
    fn taper(self, mut phase: i32) -> i32 {
        let mg = i32::from(self.0);
        let eg = i32::from(self.1);

        phase = phase.min(24);

        (mg * phase + (24 - phase) * eg) / 24
    }
}

pub static PST: [[[S; 64]; 8]; 2] = [
    init!(|i, 8| init!(|j, 64| RAW_PST[i][j ^ 56])),
    init!(|i, 8| init!(|j, 64| S(-RAW_PST[i][j].0, -RAW_PST[i][j].1))),
];
const RAW_PST: [[S; 64]; 8] = [[S(0, 0); 64], [S(0, 0); 64],
    [
        S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100),
        S(226, 181), S(276, 182), S(205, 209), S(249, 206), S(199, 224), S(108, 247), S( 13, 256), S(102, 224),
        S( 94, 150), S(119, 166), S(111, 162), S(163, 141), S(192, 140), S(130, 133), S(114, 167), S(126, 133),
        S( 79, 131), S(126, 112), S(101, 106), S(132, 108), S(143, 112), S(134,  93), S(105, 122), S( 76, 119),
        S( 72, 123), S(111, 106), S( 89, 107), S(112,  93), S(115,  91), S(109,  96), S(131, 109), S( 75, 106),
        S( 72, 114), S(101, 105), S( 76, 105), S( 86, 104), S( 98,  97), S( 96, 105), S(129, 111), S( 85,  99),
        S( 69, 130), S(103, 117), S( 77, 126), S( 79,  96), S( 90, 129), S(127, 113), S(139, 109), S( 81, 109),
        S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100), S(100, 100),
    ], [
        S(127, 203), S(305, 262), S(434, 248), S(315, 260), S(400, 230), S(255, 196), S(160, 198), S(255, 224),
        S(339, 220), S(315, 263), S(414, 251), S(359, 243), S(454, 228), S(405, 248), S(304, 253), S(403, 184),
        S(319, 267), S(372, 243), S(428, 248), S(419, 266), S(429, 266), S(414, 270), S(423, 218), S(318, 270),
        S(363, 264), S(352, 283), S(382, 268), S(404, 262), S(395, 261), S(386, 286), S(362, 291), S(346, 254),
        S(338, 244), S(376, 257), S(366, 265), S(366, 276), S(372, 272), S(379, 276), S(372, 250), S(329, 272),
        S(320, 280), S(337, 250), S(348, 274), S(377, 244), S(377, 267), S(348, 276), S(355, 260), S(320, 285),
        S(324, 186), S(318, 231), S(337, 251), S(338, 255), S(343, 253), S(342, 240), S(350, 225), S(342, 219),
        S(308, 191), S(315, 272), S(307, 189), S(302, 249), S(341, 249), S(316, 210), S(314, 264), S(289, 209),
    ], [
        S(274, 302), S(326, 296), S(345, 279), S(295, 311), S(312, 308), S(344, 274), S(374, 271), S(326, 298),
        S(359, 285), S(405, 265), S(377, 277), S(334, 277), S(382, 277), S(415, 279), S(391, 270), S(412, 266),
        S(343, 281), S(398, 282), S(378, 273), S(417, 246), S(440, 263), S(494, 276), S(437, 270), S(419, 283),
        S(325, 309), S(385, 276), S(418, 270), S(437, 263), S(429, 259), S(411, 261), S(407, 290), S(381, 277),
        S(386, 290), S(405, 249), S(387, 275), S(408, 263), S(414, 273), S(393, 264), S(396, 262), S(381, 267),
        S(387, 242), S(381, 285), S(380, 287), S(398, 268), S(395, 273), S(393, 275), S(392, 245), S(382, 266),
        S(403, 241), S(389, 235), S(396, 265), S(371, 266), S(374, 273), S(406, 245), S(395, 265), S(408, 230),
        S(396, 248), S(404, 243), S(367, 249), S(353, 261), S(366, 244), S(364, 267), S(407, 238), S(402, 254),
    ], [
        S(581, 499), S(571, 504), S(573, 484), S(595, 490), S(559, 503), S(562, 496), S(553, 497), S(530, 514),
        S(526, 495), S(534, 488), S(571, 473), S(594, 466), S(585, 474), S(600, 464), S(519, 484), S(633, 456),
        S(510, 497), S(546, 481), S(540, 469), S(576, 460), S(553, 463), S(618, 457), S(556, 468), S(507, 485),
        S(477, 499), S(513, 490), S(528, 478), S(553, 472), S(543, 470), S(505, 483), S(553, 465), S(478, 498),
        S(458, 490), S(491, 493), S(520, 464), S(485, 495), S(492, 473), S(525, 457), S(488, 482), S(488, 474),
        S(457, 500), S(506, 466), S(498, 470), S(491, 477), S(490, 485), S(487, 479), S(507, 457), S(477, 473),
        S(465, 483), S(477, 477), S(505, 470), S(487, 480), S(496, 472), S(499, 474), S(472, 472), S(447, 486),
        S(473, 476), S(485, 472), S(499, 470), S(488, 484), S(495, 470), S(484, 464), S(480, 464), S(467, 464),
    ], [
        S(923, 900), S(939, 921), S(960, 904), S(962, 912), S(982, 932), S(988, 908), S(1036, 895), S(985, 887),
        S(897, 960), S(866, 989), S(911, 978), S(969, 939), S(954, 943), S(937, 978), S(965, 901), S(974, 877),
        S(909, 898), S(939, 936), S(908, 971), S(929, 968), S(992, 941), S(981, 953), S(983, 926), S(949, 907),
        S(928, 872), S(918, 932), S(920, 949), S(919, 987), S(928, 964), S(941, 975), S(904, 978), S(935, 933),
        S(921, 919), S(926, 898), S(901, 974), S(926, 941), S(921, 958), S(898, 965), S(931, 938), S(939, 917),
        S(929, 902), S(910, 924), S(922, 922), S(909, 940), S(918, 930), S(901, 953), S(913, 931), S(913, 896),
        S(935, 855), S(950, 816), S(913, 945), S(911, 926), S(916, 924), S(935, 873), S(950, 845), S(950, 845),
        S(907, 889), S(922, 896), S(896, 906), S(909, 909), S(911, 892), S(909, 853), S(923, 822), S(971, 820),
    ], [
        S(  3, -86), S(143,   2), S(134, -20), S( 75, -14), S( 96, -31), S( 83, -20), S( 77, -29), S(-42, -115),
        S( 81, -47), S(183,  -7), S(114, -11), S(117, -10), S( 89, -11), S( 54,  -0), S( 95,   8), S(-103,  20),
        S(152, -23), S(128, -12), S(113,  -6), S( 66, -10), S( 53, -12), S(109,   0), S( 86,  13), S( 23, -16),
        S(-129,  10), S(173, -21), S( 84,   1), S( 66,  -6), S( 63,  -7), S( -1,  14), S( 49,   4), S(149, -57),
        S( 10,   3), S( 93,  -2), S(  2,  21), S( -6,  11), S(-38,  18), S( 14,   8), S(-11,  17), S( 30, -12),
        S(  7,   3), S( 14,  18), S( -7,  16), S(-28,  19), S( 29,   7), S(-28,  21), S(-37,  26), S(-70,  24),
        S( 47,  22), S(  7,  22), S(-16,  15), S(-33,  14), S(-53,  19), S(-56,  25), S(-20,  23), S( -9,  18),
        S( 21,  12), S( 27,   5), S( -6,  -1), S(-87,  12), S(-37, -10), S(-80,  16), S(-11,   9), S(-23,  -4),
    ], 
];